<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha D&D 5e - Oficial</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Open+Sans:wght@400;600;700&family=Cinzel:wght@700&display=swap');

        :root {
            --bg-body: #2c3e50;
            --bg-paper: #fdfbf6;
            --paper-texture: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            --text-main: #222;
            --text-muted: #666;
            --border-color: #aaa;
            --accent-color: #901212;
            --header-font: 'Cinzel', serif;
            --label-font: 'Libre Baskerville', serif;
            --body-font: 'Open Sans', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            font-family: var(--body-font);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Toolbar --- */
        .toolbar {
            width: 100%;
            max-width: 1100px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn {
            background: #eee; border: 1px solid #ccc; padding: 5px 10px; 
            cursor: pointer; font-size: 12px; border-radius: 3px; font-weight: bold;
            color: #333; transition: 0.2s;
        }
        .btn:hover { background: #ddd; }
        .btn-danger { background: #e74c3c; color: white; border-color: #c0392b; }
        .btn-danger:hover { background: #c0392b; }

        .tabs { display: flex; gap: 10px; }
        .tab-btn {
            background: none; border: none; font-weight: bold; color: #777; 
            cursor: pointer; padding: 5px 0; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }

        /* --- Sheet Layout --- */
        .sheet {
            background-color: var(--bg-paper);
            background-image: var(--paper-texture);
            width: 100%;
            max-width: 1100px;
            min-height: 1400px;
            padding: 40px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: none;
            position: relative;
        }
        .sheet.active { display: block; }

        input, textarea, select {
            background: transparent; border: none; width: 100%;
            font-family: var(--body-font); color: var(--text-main);
        }
        input:focus, textarea:focus, select:focus { outline: none; background: rgba(0,0,0,0.05); }
        textarea { resize: none; }

        /* --- Global Styles --- */
        .label-sm { 
            font-family: var(--label-font); font-size: 8px; font-weight: bold; 
            text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; 
        }
        .box {
            border: 1px solid var(--border-color); border-radius: 5px;
            background: white; padding: 5px; position: relative;
        }

        /* --- Header --- */
        .header-main {
            display: grid; grid-template-columns: 35% 65%; gap: 20px; margin-bottom: 25px;
        }
        .char-name-block {
            border: 1px solid var(--border-color); border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column-reverse; background: rgba(255,255,255,0.5);
        }
        .char-name-input { font-family: var(--header-font); font-size: 28px; border-bottom: 1px solid #ccc; padding: 5px; }
        
        .meta-grid {
            border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 15px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px 20px;
            background: rgba(255,255,255,0.5);
        }
        .meta-field { display: flex; flex-direction: column-reverse; }
        .meta-field input, .meta-field select { border-bottom: 1px solid #aaa; font-size: 12px; padding: 2px 0; }

        /* --- 3 Column Layout (Official Style) --- */
        .sheet-body {
            display: grid;
            grid-template-columns: 32% 34% 32%; /* Standard proportions */
            gap: 1%; /* Small gaps */
            align-items: start;
        }

        /* --- Col 1: Stats & Skills --- */
        .col-1 { display: flex; gap: 10px; }
        .stats-strip { width: 70px; display: flex; flex-direction: column; gap: 15px; }
        .skills-col { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }

        .ability-box {
            border: 1px solid var(--border-color); border-radius: 10px; text-align: center;
            background: white; position: relative; padding: 5px 0 15px 0;
        }
        .ability-label { font-weight: bold; font-size: 9px; color: #555; }
        .ability-mod { font-family: var(--body-font); font-size: 24px; font-weight: bold; }
        .ability-score-oval {
            width: 34px; height: 22px; border: 1px solid var(--border-color); border-radius: 12px;
            background: white; position: absolute; bottom: -11px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; justify-content: center; z-index: 2;
        }
        .ability-input { font-size: 12px; text-align: center; width: 30px; }

        .insp-box { border: 1px solid var(--border-color); border-radius: 10px; padding: 5px; display: flex; align-items: center; justify-content: space-between; background: white; }
        .prof-box { border: 1px solid var(--border-color); border-radius: 10px; padding: 5px; display: flex; align-items: center; justify-content: space-between; background: white; margin-bottom: 10px;}
        
        .prof-val { font-size: 16px; font-weight: bold; border: 1px solid #555; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 5px; }

        .skill-container { border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; background: white; font-size: 11px; }
        .skill-row { display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 2px 0; }
        .skill-mod { width: 20px; text-align: center; color: #555; margin: 0 5px; }
        .skill-name { flex-grow: 1; }
        .skill-attr { color: #999; font-size: 9px; }
        
        .marker { width: 10px; height: 10px; border: 1px solid #777; border-radius: 50%; cursor: pointer; background: #fff; }
        .marker[data-val="1"] { background: #333; }
        .marker[data-val="2"] { background: #333; box-shadow: 0 0 0 2px #fff, 0 0 0 3px #333; }

        .passive-perc { border: 1px solid var(--border-color); border-radius: 20px; padding: 5px 15px; margin-top: 10px; display: flex; align-items: center; background: white; font-size: 11px; color: #555; }
        
        .langs-box { border: 1px solid var(--border-color); border-radius: 10px; padding: 10px; background: white; margin-top: 10px; flex-grow: 1; min-height: 150px; display: flex; flex-direction: column; }

        /* --- Col 2: Combat --- */
        .col-2 { display: flex; flex-direction: column; gap: 10px; padding: 0 5px; }
        
        .combat-header { display: flex; gap: 5px; background: #eee; border-radius: 10px; padding: 5px; border: 1px solid #ccc; }
        .combat-stat { flex: 1; display: flex; flex-direction: column; align-items: center; background: white; border: 1px solid #ccc; border-radius: 5px; padding: 5px; }
        .combat-val { font-size: 24px; font-weight: bold; text-align: center; font-family: var(--header-font); }

        .hp-box { border: 1px solid var(--border-color); border-radius: 10px; background: white; padding: 5px 10px; }
        .hp-top { display: flex; justify-content: space-between; font-size: 10px; color: #777; margin-bottom: 2px; }
        .hp-big { font-size: 30px; text-align: center; width: 100%; font-family: var(--header-font); }

        .hd-ds-row { display: flex; gap: 10px; }
        .ds-row { display: flex; justify-content: space-between; align-items: center; font-size: 10px; margin: 2px 0; }
        .ds-bubbles { display: flex; gap: 3px; }

        .attacks-box { border: 1px solid var(--border-color); border-radius: 10px; background: white; flex-grow: 0; min-height: 250px; padding: 5px; display: flex; flex-direction: column; }
        .atk-table { width: 100%; font-size: 11px; border-collapse: collapse; }
        .atk-table th { text-align: left; color: #777; border-bottom: 1px solid #ccc; font-size: 9px; padding: 2px; }
        .atk-table td { padding: 4px 0; border-bottom: 1px solid #eee; }
        .atk-input { background: #fafafa; padding: 3px; border-radius: 3px; }

        .equip-row { display: flex; gap: 5px; margin-top: 10px; flex-grow: 1; }
        .coins-col { width: 50px; display: flex; flex-direction: column; gap: 3px; }
        .coin-box { border: 1px solid var(--border-color); border-radius: 5px; padding: 2px; background: #fdfdfd; display: flex; flex-direction: column; align-items: center; }
        .coin-label { font-size: 8px; font-weight: bold; color: #555; }
        .coin-val { font-size: 12px; text-align: center; width: 100%; }

        /* --- Col 3: Traits --- */
        .col-3 { display: flex; flex-direction: column; gap: 10px; }
        .trait-box { border: 1px solid var(--border-color); border-radius: 10px; background: white; padding: 10px; min-height: 80px; position: relative; }
        .trait-title { position: absolute; top: -8px; left: 10px; background: white; padding: 0 5px; font-weight: bold; font-size: 10px; text-transform: uppercase; color: #333; letter-spacing: 1px;}
        .trait-text { font-size: 11px; height: 100%; width: 100%; margin-top: 5px; line-height: 1.4; }

        .features-box { flex-grow: 1; min-height: 300px; border: 1px solid var(--border-color); border-radius: 10px; background: white; padding: 10px; position: relative; }

        /* --- Spells Page --- */
        .spells-header { background: #333; color: white; padding: 15px; border-radius: 5px; display: flex; gap: 10px; text-align: center; margin-bottom: 20px;}
        .spell-stat { flex: 1; border-right: 1px solid #555; }
        .spell-stat:last-child { border: none; }
        .spell-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .spell-lvl-box { border: 1px solid #ccc; border-radius: 5px; background: white; overflow: hidden; }
        .spell-lvl-head { background: #eee; padding: 5px 10px; font-weight: bold; font-family: var(--header-font); font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .spell-slots-bubbles { display: flex; gap: 3px; }
        .slot-bubble { width: 12px; height: 12px; border: 1px solid #555; border-radius: 50%; cursor: pointer; background: white; }
        .slot-bubble.used { background: var(--accent-color); border-color: var(--accent-color); }
        .spell-list { padding: 5px; }
        .spell-row { display: flex; align-items: center; border-bottom: 1px dotted #ddd; padding: 2px 0; }

        @media print {
            .toolbar { display: none; }
            .sheet { display: block; margin: 0; box-shadow: none; padding: 0; page-break-after: always; width: 100%; max-width: none; }
            body { background: white; padding: 0; }
        }
    </style>
</head>
<body>

<div class="toolbar">
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="font-weight: bold; color: var(--accent-color); font-family: var(--header-font);">D&D 5e</span>
        <div class="tabs">
            <button class="tab-btn active" onclick="showPage('page1')">Principal</button>
            <button class="tab-btn" onclick="showPage('page2')">Bio</button>
            <button class="tab-btn" onclick="showPage('page3')">Magias</button>
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn" onclick="resetShort()">Descanso Curto</button>
        <button class="btn btn-danger" onclick="resetLong()">Descanso Longo</button>
        <button class="btn" onclick="saveJSON()">ðŸ’¾ Salvar</button>
        <button class="btn" onclick="document.getElementById('fileUp').click()">ðŸ“‚ Abrir</button>
        <input type="file" id="fileUp" style="display:none" onchange="loadJSON(this)">
    </div>
</div>

<!-- ================= PAGE 1 ================= -->
<div id="page1" class="sheet active">
    <!-- Header -->
    <div class="header-main">
        <div class="char-name-block">
            <input type="text" class="char-name-input sync-name" id="charName">
            <div class="label-sm">Nome do Personagem</div>
        </div>
        <div class="meta-grid">
            <div class="meta-field"><input type="text" id="classLevel" onchange="recalc()"><div class="label-sm">Classe & NÃ­vel</div></div>
            <div class="meta-field"><input type="text" id="background"><div class="label-sm">Antecedentes</div></div>
            <div class="meta-field"><input type="text" id="player"><div class="label-sm">Jogador</div></div>
            <div class="meta-field"><input type="text" id="race"><div class="label-sm">RaÃ§a</div></div>
            <div class="meta-field">
                <select id="alignment">
                    <option value=""></option><option>LB</option><option>NB</option><option>CB</option>
                    <option>LN</option><option>N</option><option>CN</option>
                    <option>LM</option><option>NM</option><option>CM</option>
                </select>
                <div class="label-sm">TendÃªncia</div>
            </div>
            <div class="meta-field"><input type="text" id="xp"><div class="label-sm">XP</div></div>
        </div>
    </div>

    <!-- Official 3 Column Layout -->
    <div class="sheet-body">
        
        <!-- COL 1: Stats & Skills -->
        <div class="col-1">
            <div class="stats-strip" id="statsStrip">
                <!-- Generated by JS -->
            </div>
            
            <div class="skills-col">
                <div class="insp-box">
                    <input type="number" id="inspiration" style="width: 40px; height: 35px; font-size: 20px; font-weight: bold; text-align: center; border: 1px solid #777; border-radius: 5px;" placeholder="0">
                    <div class="label-sm" style="margin-left: 5px;">InspiraÃ§Ã£o</div>
                </div>
                
                <div class="prof-box">
                    <div class="prof-val" id="profBonus">+2</div>
                    <div class="label-sm">BÃ´nus de<br>ProficiÃªncia</div>
                </div>

                <div class="skill-container">
                    <div class="label-sm" style="text-align: center; margin-bottom: 5px;">Testes de ResistÃªncia</div>
                    <div id="savesList"></div>
                </div>

                <div class="skill-container">
                    <div class="label-sm" style="text-align: center; margin-bottom: 5px;">PerÃ­cias</div>
                    <div id="skillsList"></div>
                </div>

                <div class="passive-perc">
                    <span style="font-weight: bold; font-size: 14px; margin-right: 10px;" id="passivePerc">10</span>
                    Sabedoria Passiva (PercepÃ§Ã£o)
                </div>

                <div class="langs-box">
                    <div class="label-sm">Outras ProficiÃªncias & Idiomas</div>
                    <textarea id="langs" style="margin-top: 5px; height: 100%;"></textarea>
                </div>
            </div>
        </div>

        <!-- COL 2: Combat -->
        <div class="col-2">
            <div class="combat-header">
                <div class="combat-stat"><input type="text" class="combat-val" id="ac" value="10"><div class="label-sm">Classe Armadura</div></div>
                <div class="combat-stat"><input type="text" class="combat-val" id="init" value="0"><div class="label-sm">Iniciativa</div></div>
                <div class="combat-stat"><input type="text" class="combat-val" id="speed" value="9m"><div class="label-sm">Deslocamento</div></div>
            </div>

            <div class="hp-box">
                <div class="hp-top"><span>Pontos de Vida MÃ¡ximos</span><input type="number" id="hpMax" style="width: 50px; text-align: right; border-bottom: 1px solid #ccc;"></div>
                <input type="number" id="hpCurrent" class="hp-big" placeholder="Atual">
                <div class="label-sm" style="text-align: center;">Pontos de Vida Atuais</div>
            </div>

            <div class="hp-box">
                <input type="number" id="hpTemp" class="hp-big" placeholder="Temp" style="font-size: 20px;">
                <div class="label-sm" style="text-align: center;">Pontos de Vida TemporÃ¡rios</div>
            </div>

            <div class="hd-ds-row">
                <div class="hp-box" style="flex: 1;">
                    <div class="label-sm">Dados de Vida</div>
                    <div style="display: flex; align-items: center; justify-content: center; margin-top: 5px;">
                        <input type="text" id="hdTotal" placeholder="Total" style="width: 30px; text-align: center; border-right: 1px solid #ccc; margin-right: 5px;">
                        <input type="text" id="hdCurrent" placeholder="1d8" style="font-size: 16px; text-align: center;">
                    </div>
                </div>
                <div class="hp-box" style="flex: 1;">
                    <div class="label-sm" style="text-align: center; margin-bottom: 2px;">Testes de Morte</div>
                    <div class="ds-row">
                        <span>Sucessos</span>
                        <div class="ds-bubbles">
                            <div class="marker" id="dsS1" onclick="toggleMarker(this, 1)"></div>
                            <div class="marker" id="dsS2" onclick="toggleMarker(this, 1)"></div>
                            <div class="marker" id="dsS3" onclick="toggleMarker(this, 1)"></div>
                        </div>
                    </div>
                    <div class="ds-row">
                        <span>Falhas</span>
                        <div class="ds-bubbles">
                            <div class="marker" id="dsF1" onclick="toggleMarker(this, 1)"></div>
                            <div class="marker" id="dsF2" onclick="toggleMarker(this, 1)"></div>
                            <div class="marker" id="dsF3" onclick="toggleMarker(this, 1)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="attacks-box">
                <div class="label-sm" style="text-align: center; margin-bottom: 5px;">Ataques e Magias</div>
                <table class="atk-table">
                    <thead><tr><th width="40%">Nome</th><th width="20%">BÃ´nus</th><th width="40%">Dano/Tipo</th></tr></thead>
                    <tbody id="atkRows"></tbody>
                </table>
                <textarea id="atkNotes" style="flex-grow: 1; border-top: 1px solid #eee; margin-top: 5px; padding: 5px;" placeholder="Notas..."></textarea>
            </div>

            <div class="equip-row">
                <div class="coins-col">
                    <div class="coin-box"><div class="coin-label">PC</div><input type="text" id="cp" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label">PP</div><input type="text" id="sp" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label">PE</div><input type="text" id="ep" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label" style="color: #d4ac0d;">PO</div><input type="text" id="gp" class="coin-val"></div>
                    <div class="coin-box"><div class="coin-label">PL</div><input type="text" id="pp" class="coin-val"></div>
                </div>
                <div class="box" style="flex-grow: 1;">
                    <div class="label-sm" style="text-align: center;">Equipamento</div>
                    <textarea id="equip" style="height: 100%; min-height: 150px;"></textarea>
                </div>
            </div>
        </div>

        <!-- COL 3: Traits -->
        <div class="col-3">
            <div class="trait-box">
                <div class="trait-title">TraÃ§os de Personalidade</div>
                <textarea id="traits" class="trait-text"></textarea>
            </div>
            <div class="trait-box">
                <div class="trait-title">Ideais</div>
                <textarea id="ideals" class="trait-text"></textarea>
            </div>
            <div class="trait-box">
                <div class="trait-title">VÃ­nculos</div>
                <textarea id="bonds" class="trait-text"></textarea>
            </div>
            <div class="trait-box">
                <div class="trait-title">Fraquezas</div>
                <textarea id="flaws" class="trait-text"></textarea>
            </div>
            <div class="features-box">
                <div class="trait-title">CaracterÃ­sticas e Talentos</div>
                <textarea id="features" class="trait-text" style="height: 100%;"></textarea>
            </div>
        </div>
    </div>
</div>

<!-- ================= PAGE 2: BIO ================= -->
<div id="page2" class="sheet">
    <div class="header-main">
        <div class="char-name-block">
            <input type="text" class="char-name-input sync-name">
            <div class="label-sm">Nome do Personagem</div>
        </div>
        <div style="display: flex; align-items: flex-end; padding-bottom: 10px; font-size: 24px; font-family: var(--header-font);">
            Biografia
        </div>
    </div>

    <div class="meta-grid" style="grid-template-columns: repeat(6, 1fr); margin-bottom: 20px;">
        <div class="meta-field"><input type="text" id="age"><div class="label-sm">Idade</div></div>
        <div class="meta-field"><input type="text" id="height"><div class="label-sm">Altura</div></div>
        <div class="meta-field"><input type="text" id="weight"><div class="label-sm">Peso</div></div>
        <div class="meta-field"><input type="text" id="eyes"><div class="label-sm">Olhos</div></div>
        <div class="meta-field"><input type="text" id="skin"><div class="label-sm">Pele</div></div>
        <div class="meta-field"><input type="text" id="hair"><div class="label-sm">Cabelo</div></div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <div class="box" style="padding: 15px;">
                <div class="label-sm">HistÃ³ria do Personagem</div>
                <textarea id="backstory" style="height: 400px; margin-top: 10px;"></textarea>
            </div>
            <div class="box" style="padding: 15px;">
                <div class="label-sm">Aliados & OrganizaÃ§Ãµes</div>
                <textarea id="allies" style="height: 150px; margin-top: 10px;"></textarea>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 20px;">
             <div class="box" style="height: 250px; background: #eee; display: flex; align-items: center; justify-content: center; text-align: center; color: #999;">
                 [Imagem do Personagem]
             </div>
             <div class="box" style="padding: 15px;">
                <div class="label-sm">AparÃªncia</div>
                <textarea id="appearance" style="height: 150px; margin-top: 10px;"></textarea>
             </div>
             <div class="box" style="padding: 15px;">
                <div class="label-sm">Tesouro Adicional</div>
                <textarea id="treasure" style="height: 150px; margin-top: 10px;"></textarea>
             </div>
        </div>
    </div>
</div>

<!-- ================= PAGE 3: SPELLS ================= -->
<div id="page3" class="sheet">
    <div class="header-main">
        <div class="char-name-block">
            <input type="text" class="char-name-input sync-name">
            <div class="label-sm">Nome do Personagem</div>
        </div>
        <div style="display: flex; align-items: flex-end; padding-bottom: 10px; font-size: 24px; font-family: var(--header-font);">
            GrimÃ³rio
        </div>
    </div>

    <div class="spells-header">
        <div class="spell-stat">
            <input id="spellClass" style="color: white; border-bottom: 1px solid white; text-align: center; font-size: 16px;" placeholder="Classe">
            <div class="label-sm" style="color: #aaa;">Classe Conjuradora</div>
        </div>
        <div class="spell-stat">
            <select id="spellAbility" onchange="recalc()" style="color: white; border-bottom: 1px solid white; text-align: center; font-size: 16px;">
                <option value="int">InteligÃªncia</option>
                <option value="wis">Sabedoria</option>
                <option value="cha">Carisma</option>
            </select>
            <div class="label-sm" style="color: #aaa;">Atributo Chave</div>
        </div>
        <div class="spell-stat">
            <div id="spellDC" style="font-size: 24px; font-weight: bold;">10</div>
            <div class="label-sm" style="color: #aaa;">CD ResistÃªncia</div>
        </div>
        <div class="spell-stat">
            <div id="spellAtk" style="font-size: 24px; font-weight: bold;">+2</div>
            <div class="label-sm" style="color: #aaa;">BÃ´nus Ataque</div>
        </div>
    </div>

    <div class="spell-grid" id="spellContainer"></div>
</div>

<script>
    /* CONFIG */
    const attrs = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const attrNames = {str:'ForÃ§a', dex:'Destreza', con:'ConstituiÃ§Ã£o', int:'InteligÃªncia', wis:'Sabedoria', cha:'Carisma'};
    const skills = [
        {id:'acrob', name:'Acrobacia', at:'dex'}, {id:'animal', name:'Adestrar Animais', at:'wis'},
        {id:'arcana', name:'Arcanismo', at:'int'}, {id:'athlet', name:'Atletismo', at:'str'},
        {id:'decept', name:'EnganaÃ§Ã£o', at:'cha'}, {id:'history', name:'HistÃ³ria', at:'int'},
        {id:'insight', name:'IntuiÃ§Ã£o', at:'wis'}, {id:'intimid', name:'IntimidaÃ§Ã£o', at:'cha'},
        {id:'invest', name:'InvestigaÃ§Ã£o', at:'int'}, {id:'medicine', name:'Medicina', at:'wis'},
        {id:'nature', name:'Natureza', at:'int'}, {id:'percep', name:'PercepÃ§Ã£o', at:'wis'},
        {id:'persuas', name:'PersuasÃ£o', at:'cha'}, {id:'perform', name:'AtuaÃ§Ã£o', at:'cha'},
        {id:'religion', name:'ReligiÃ£o', at:'int'}, {id:'sleight', name:'PrestidigitaÃ§Ã£o', at:'dex'},
        {id:'stealth', name:'Furtividade', at:'dex'}, {id:'survival', name:'SobrevivÃªncia', at:'wis'}
    ];

    /* INIT */
    window.onload = function() {
        buildUI();
        loadLocal();
        recalc();
        setupEvents();
    };

    function buildUI() {
        // Attributes Strip
        const st = document.getElementById('statsStrip');
        attrs.forEach(a => {
            st.innerHTML += `
            <div class="ability-box">
                <div class="ability-label">${attrNames[a].toUpperCase()}</div>
                <div class="ability-mod" id="mod_${a}">+0</div>
                <div class="ability-score-oval">
                    <input type="number" class="ability-input" id="score_${a}" value="10">
                </div>
            </div>`;
        });

        // Saves
        const sl = document.getElementById('savesList');
        attrs.forEach(a => {
            sl.innerHTML += `
            <div class="skill-row">
                <div class="marker" id="save_${a}" data-val="0" onclick="toggleMarker(this, 1)"></div>
                <div class="skill-mod" id="saveVal_${a}">+0</div>
                <div class="skill-name">${attrNames[a]}</div>
            </div>`;
        });

        // Skills
        const skl = document.getElementById('skillsList');
        skills.forEach(s => {
            skl.innerHTML += `
            <div class="skill-row">
                <div class="marker" id="skill_${s.id}" data-val="0" onclick="toggleMarker(this, 2)"></div>
                <div class="skill-mod" id="skillVal_${s.id}">+0</div>
                <div class="skill-name">${s.name} <span class="skill-attr">(${s.at.substring(0,3).toUpperCase()})</span></div>
            </div>`;
        });

        // Attacks
        const atk = document.getElementById('atkRows');
        for(let i=0; i<5; i++) {
            atk.innerHTML += `
            <tr>
                <td><input class="atk-input" id="atkN${i}"></td>
                <td><input class="atk-input" id="atkB${i}" style="text-align:center;"></td>
                <td><input class="atk-input" id="atkD${i}"></td>
            </tr>`;
        }

        // Spells
        const spc = document.getElementById('spellContainer');
        // Cantrips
        spc.innerHTML += `
        <div class="spell-lvl-box">
            <div class="spell-lvl-head">Truques (0)</div>
            <div class="spell-list">
                ${Array(8).fill(0).map((_,i) => `<div class="spell-row"><input id="cantrip${i}" style="font-size:11px;"></div>`).join('')}
            </div>
        </div>`;
        // Lvls 1-9
        for(let i=1; i<=9; i++) {
            spc.innerHTML += `
            <div class="spell-lvl-box">
                <div class="spell-lvl-head">
                    <span>NÃ­vel ${i}</span>
                    <div class="spell-slots-bubbles">
                        ${Array(4).fill(0).map((_,j) => `<div class="slot-bubble" id="slot_${i}_${j}" onclick="toggleSlot(this)"></div>`).join('')}
                    </div>
                </div>
                <div class="spell-list">
                    ${Array(i<3?7:5).fill(0).map((_,k) => `
                        <div class="spell-row">
                            <div class="marker" id="prep_${i}_${k}" data-val="0" onclick="toggleMarker(this, 1)" style="width:8px; height:8px; margin-right:5px;"></div>
                            <input id="spell_${i}_${k}" style="font-size:11px;">
                        </div>`).join('')}
                </div>
            </div>`;
        }
    }

    /* LOGIC */
    function getMod(sc) { return Math.floor((sc - 10) / 2); }
    function fmt(n) { return n >= 0 ? "+" + n : n; }

    function recalc() {
        // PB
        const lvlStr = document.getElementById('classLevel').value || "";
        const lvl = parseInt(lvlStr.match(/\d+/)) || 1;
        let pb = 2;
        if(lvl >= 5) pb = 3; if(lvl >= 9) pb = 4; if(lvl >= 13) pb = 5; if(lvl >= 17) pb = 6;
        document.getElementById('profBonus').innerText = fmt(pb);

        // Mods
        let mods = {};
        attrs.forEach(a => {
            const sc = parseInt(document.getElementById('score_'+a).value) || 10;
            const mod = getMod(sc);
            mods[a] = mod;
            document.getElementById('mod_'+a).innerText = fmt(mod);
        });

        // Saves
        attrs.forEach(a => {
            const prof = parseInt(document.getElementById('save_'+a).dataset.val);
            const val = mods[a] + (prof * pb);
            document.getElementById('saveVal_'+a).innerText = fmt(val);
        });

        // Skills
        skills.forEach(s => {
            const prof = parseInt(document.getElementById('skill_'+s.id).dataset.val); // 0, 1, 2
            let bonus = 0; 
            if(prof === 1) bonus = pb;
            if(prof === 2) bonus = pb * 2;
            document.getElementById('skillVal_'+s.id).innerText = fmt(mods[s.at] + bonus);
        });

        // Passive
        const pProf = parseInt(document.getElementById('skill_percep').dataset.val);
        let pBonus = 0; if(pProf===1) pBonus=pb; if(pProf===2) pBonus=pb*2;
        document.getElementById('passivePerc').innerText = 10 + mods['wis'] + pBonus;

        // Spell
        const sa = document.getElementById('spellAbility').value;
        const dc = 8 + pb + mods[sa];
        const atk = pb + mods[sa];
        document.getElementById('spellDC').innerText = dc;
        document.getElementById('spellAtk').innerText = fmt(atk);
    }

    /* ACTIONS */
    function showPage(pid) {
        document.querySelectorAll('.sheet').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        // highlight tab logic simple
        const idx = pid==='page1'?0:(pid==='page2'?1:2);
        document.querySelectorAll('.tab-btn')[idx].classList.add('active');
    }

    function toggleMarker(el, max) {
        let v = parseInt(el.dataset.val);
        v++; if(v > max) v = 0;
        el.dataset.val = v;
        recalc();
        saveLocal();
    }
    
    function toggleSlot(el) {
        el.classList.toggle('used');
        saveLocal();
    }

    function setupEvents() {
        document.querySelectorAll('input, textarea, select').forEach(el => {
            el.addEventListener('input', () => {
                if(el.classList.contains('sync-name')) {
                    document.querySelectorAll('.sync-name').forEach(x => x.value = el.value);
                }
                if(el.id.includes('score_') || el.id === 'classLevel' || el.id === 'spellAbility') recalc();
                saveLocal();
            });
        });
    }

    /* PERSISTENCE */
    function saveLocal() {
        const data = { vals: {}, markers: {}, slots: [] };
        document.querySelectorAll('input, textarea, select').forEach(el => { if(el.id) data.vals[el.id] = el.value; });
        document.querySelectorAll('.marker').forEach(el => { if(el.id) data.markers[el.id] = el.dataset.val; });
        document.querySelectorAll('.slot-bubble.used').forEach(el => data.slots.push(el.id));
        localStorage.setItem('dndSheetOfficial', JSON.stringify(data));
    }
    function loadLocal() {
        const d = localStorage.getItem('dndSheetOfficial');
        if(d) applyData(JSON.parse(d));
    }
    function applyData(d) {
        if(!d) return;
        for(let k in d.vals) { const el=document.getElementById(k); if(el) el.value=d.vals[k]; }
        for(let k in d.markers) { const el=document.getElementById(k); if(el) el.dataset.val=d.markers[k]; }
        document.querySelectorAll('.slot-bubble').forEach(e => e.classList.remove('used'));
        if(d.slots) d.slots.forEach(id => { const el=document.getElementById(id); if(el) el.classList.add('used'); });
        recalc();
    }
    
    function saveJSON() {
        saveLocal();
        const d = localStorage.getItem('dndSheetOfficial');
        const n = document.getElementById('charName').value || 'Personagem';
        const b = new Blob([d], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n+'.json'; a.click();
    }
    function loadJSON(inp) {
        const f = inp.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => { applyData(JSON.parse(e.target.result)); saveLocal(); alert('Carregado!'); };
        r.readAsText(f);
    }

    function resetShort() {
        if(confirm("Descanso Curto: Recuperar Magias de Bruxo e Habilidades?")) {
            // Logic: usually resets Pact Magic. Here we just offer manual clear or nothing.
            // Let's just say "Done" or clear slots if user wants.
            // Simpler: Just save.
            saveLocal();
        }
    }
    function resetLong() {
        if(confirm("Descanso Longo: Recuperar PV e Slots?")) {
            const max = document.getElementById('hpMax').value;
            if(max) document.getElementById('hpCurrent').value = max;
            document.getElementById('hpTemp').value = '';
            document.querySelectorAll('.slot-bubble').forEach(e => e.classList.remove('used'));
            saveLocal();
        }
    }

</script>

</body>
</html>